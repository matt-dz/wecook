ifneq (,$(wildcard ./.env))
    include .env
    export
endif

SERVER_DIR:=cmd/wecook
SERVER_BIN:=wecook
DOCKER_NAME:=wecook
BIN_DIR:=bin

.PHONY: all
all: build

.PHONY: build
build:
	@echo "ğŸ”¨  Building $(SERVER_BIN)â€¦"
	go build -o $(BIN_DIR)/$(SERVER_BIN) $(SERVER_DIR)/main.go
	@echo "âœ“  Built $(BIN_DIR)/$(SERVER_BIN)"

.PHONY: docker-build
docker-build:
	@echo "ğŸ”¨ğŸ³ Building docker image \"$(SERVER_BIN)\" with tag \"$(DOCKER_NAME)\""
	docker build -f Dockerfile -t $(DOCKER_NAME) .
	@echo "âœ“  Built $(SERVER_BIN)"

.PHONY: run
run: swagger
	@echo "ğŸš€  Starting..."
	go run $(SERVER_DIR)/main.go

.PHONY: fmt
fmt: swagger-fmt sql-fmt
	@echo "ğŸ¨  Formatting source code..."
	golangci-lint fmt -v

.PHONY: lint
lint:
	@echo "ğŸ”  Linting source code..."
	golangci-lint run -v

.PHONY: swagger
swagger:
	@echo "ğŸ“œ  Generating swagger docs..."
	swag init -g internal/api/api.go \
		--parseInternal --parseDependency

.PHONY: swagger-fmt
swagger-fmt:
	@echo "ğŸ¨  Formatting swagger docs..."
	swag fmt

.PHONY: sql-fmt
sql-fmt:
	@echo "ğŸ¨ Formatting SQL"
	pg_format -i query.sql schema.sql

.PHONY: sqlc
sqlc:
	@echo "ğŸ—„ï¸  Generating SQLC code..."
	sqlc generate

.PHONY: clean
clean:
	@echo "ğŸ§¹ Cleaning $(BIN_DIR)"
	rm $(BIN_DIR)/*

.PHONY: keys
keys:
	@python3 scripts/generate-keys.py \
		--jwks-path ./keys/jwks.json \
		--private-keys-path ./keys/private-keys.json

.PHONY: help
help:
	@cat Makefile

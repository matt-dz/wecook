openapi: 3.0.3
info:
  title: WeCook API
  version: "1.0"
  description: API Server for the WeCook application.
  contact: {}

servers:
  - url: /

security:
  - AccessTokenUserBearer: []

paths:
  /api/openapi.yaml:
    get:
      summary: Get OpenAPI specification.
      tags:
        - Documentation
      responses:
        "200":
          description: OpenAPI specification file
          content:
            application/x-yaml:
              schema:
                type: string
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security: []

  /api/ping:
    get:
      summary: Ping endpoint.
      tags:
        - Ping
      responses:
        "200":
          description: OK
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security: []

  /api/admin:
    post:
      summary: Create an admin.
      tags:
        - Admin
      requestBody:
        description: Create Admin Request
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAdminRequest"
      responses:
        "204":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateAdminResponse"
        "409":
          description: Status Conflict
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Unprocessible Entity
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - AccessTokenAdminBearer: []

  /api/admin/user:
    post:
      summary: Create a user.
      tags:
        - User
      requestBody:
        description: Create User Request
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateUserRequest"
      responses:
        "204":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateUserResponse"
        "409":
          description: Status Conflict
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Unprocessible Entity
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
      security:
        - AccessTokenAdminBearer: []

  /api/auth/refresh:
    post:
      summary: Refresh session tokens
      tags:
        - Auth
      description: >
        Uses a valid refresh token cookie to issue a new access and refresh token pair.
      security: []
      parameters:
        - name: refresh
          in: cookie
          schema:
            type: string
          description: Refresh token
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshToken"
      responses:
        "200":
          description: >
            OK - For browser clients, access and refresh tokens are set as HTTP-only
            cookies. For API clients/Swagger, an access token is also returned in the body.
          headers:
            Set-Cookie:
              description: >
                HTTP-only cookies for access and refresh tokens. This header is sent twice:
                once for the "access" cookie and once for the "refresh" cookie.
              schema:
                type: string
              examples:
                access:
                  summary: Access token cookie
                  value: access=<jwt_token>; HttpOnly; Secure; SameSite=Lax; Path=/
                refresh:
                  summary: Refresh token cookie
                  value: refresh=<jwt_token>; HttpOnly; Secure; SameSite=Lax; Path=/
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "401":
          description: Expired, invalid, or missing refresh token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/auth/verify:
    get:
      summary: Verify user session
      tags:
        - Auth
      description: |
        Validates the user's access token cookie, checks expiration,
        and ensures the user has the required role.
      parameters:
        - name: access
          in: cookie
          schema:
            type: string
          description: Access token
      responses:
        "204":
          description: Session is valid
        "401":
          description: Expired, invalid, or missing access token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/login:
    post:
      summary: User login.
      tags:
        - User
        - Auth
      security: []
      requestBody:
        description: User Login Request
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserLoginRequest"
      responses:
        "200":
          description: >
            OK - For browser clients, access and refresh tokens are set as HTTP-only
            cookies. For API clients/Swagger, an access token is also returned in the body.
          headers:
            Set-Cookie:
              description: >
                HTTP-only cookies for access and refresh tokens. This header is sent twice:
                once for the "access" cookie and once for the "refresh" cookie.
              schema:
                type: string
              examples:
                access:
                  summary: Access token cookie
                  value: access=<jwt_token>; HttpOnly; Secure; SameSite=Lax; Path=/
                refresh:
                  summary: Refresh token cookie
                  value: refresh=<jwt_token>; HttpOnly; Secure; SameSite=Lax; Path=/
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/recipes:
    post:
      summary: Create a new recipe
      tags:
        - Recipes
      description: >
        Creates a new (empty) recipe for the authenticated user.
      responses:
        "201":
          description: Recipe successfully created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateRecipeResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized — missing or invalid access token cookie
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/recipes/{recipeID}:
    get:
      summary: Get a public recipe and its owner's information
      tags:
        - Recipes
      description: >
        Retrieves a recipe by ID, including recipe details and the owner's basic information.
      parameters:
        - name: recipeID
          in: path
          required: true
          description: ID of the recipe to retrieve
          schema:
            type: integer
            format: int64
            minimum: 0
      security: []
      responses:
        "200":
          description: Recipe found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetRecipeResponse"
        "400":
          description: Bad request (invalid recipe ID)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Recipe not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Delete a recipe
      tags:
        - Recipes
      description: >
        Deletes a recipe owned by the authenticated user.
        This operation is idempotent — deleting an already deleted 
        or non-owned recipe results in a 404.
      parameters:
        - name: recipeID
          in: path
          required: true
          description: ID of the recipe to retrieve
          schema:
            type: integer
            format: int64
            minimum: 0
      responses:
        "204":
          description: Recipe deleted successfully
        "400":
          description: Bad request (invalid recipe ID)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Recipe not found or not owned by user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/recipes/{recipeID}/ingredients:
    post:
      summary: Create an ingredient for a recipe.
      tags:
        - Recipes
        - Ingredients
      description: >
        Creates an ingredient for the recipe. The recipe must be
        owned by the user.
      parameters:
        - name: recipeID
          in: path
          required: true
          description: ID of the recipe to retrieve
          schema:
            type: integer
            format: int64
            minimum: 0
      responses:
        "200":
          description: Ingredient Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateIngredientResponse"
        "404":
          description: Recipe not found or not owned by user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /api/recipes/{recipeID}/ingredients/{ingredientID}:
    patch:
      summary: Update an ingredient for a recipe.
      tags:
        - Recipes
        - Ingredients
      description: >
        Updates an ingredient for the recipe. The recipe must be
        owned by the user. If no fields are provided, the operation
        is considered a no-op.
      parameters:
        - name: recipeID
          in: path
          required: true
          description: Recipe ID
          schema:
            type: integer
            format: int64
            minimum: 0
        - name: ingredientID
          in: path
          required: true
          description: Ingredient ID
          schema:
            type: integer
            format: int64
            minimum: 0
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateIngredientBody"
      responses:
        "200":
          description: Ingredient Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateIngredientResponse"
        "400":
          description: Invalid Form
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Recipe not found or not owned by user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/recipes/{recipeID}/ingredients/{ingredientID}/image:
    post:
      summary: Upload an image for a recipe ingredient
      tags:
        - Recipes
        - Ingredients
      description: >
        Uploads an image for a recipe ingredient. The recipe must be
        owned by the user.
      parameters:
        - name: recipeID
          in: path
          required: true
          description: Recipe ID
          schema:
            type: integer
            format: int64
            minimum: 0
        - name: ingredientID
          in: path
          required: true
          description: Ingredient ID
          schema:
            type: integer
            format: int64
            minimum: 0
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/UpdateIngredientImageForm"
      responses:
        "200":
          description: Image uploaded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateIngredientImageResponse"
        "400":
          description: Invalid request or file format
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Recipe or ingredient not found or not owned by user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete an image from a recipe ingredient
      tags:
        - Recipes
        - Ingredients
      description: >
        Deletes an image from a recipe ingredient. The recipe must be
        owned by the user.
      parameters:
        - name: recipeID
          in: path
          required: true
          description: Recipe ID
          schema:
            type: integer
            format: int64
            minimum: 0
        - name: ingredientID
          in: path
          required: true
          description: Ingredient ID
          schema:
            type: integer
            format: int64
            minimum: 0
      responses:
        "200":
          description: Image deleted successfully
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Recipe or ingredient not found or not owned by user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # /api/recipes/personal:
  #   get:
  #     summary: Get recipes owned by the authenticated user
  #     tags:
  #       - Recipes
  #     description: >
  #       Returns all recipes created by the authenticated user, including
  #       recipe details and owner information.
  #     responses:
  #       "200":
  #         description: List of personal recipes
  #         content:
  #           application/json:
  #             schema:
  #               $ref: "#/components/schemas/GetPersonalRecipesResponse"
  #       "401":
  #         description: Unauthorized
  #         content:
  #           application/json:
  #             schema:
  #               $ref: "#/components/schemas/Error"
  #       "500":
  #         description: Internal server error
  #         content:
  #           application/json:
  #             schema:
  #               $ref: "#/components/schemas/Error"
  #
  # /api/recipes/personal/{recipeID}:
  #   get:
  #     summary: Get a personal (owned) recipe
  #     tags:
  #       - Recipes
  #     description: |
  #       Retrieves a recipe **only if it is owned by the authenticated user**.
  #       Includes full recipe details: steps, ingredients, metadata, and owner info.
  #     parameters:
  #       - name: recipeID
  #         in: path
  #         required: true
  #         description: ID of the recipe
  #         schema:
  #           type: integer
  #     responses:
  #       "200":
  #         description: Full recipe with steps and ingredients
  #         content:
  #           application/json:
  #             schema:
  #               $ref: "#/components/schemas/GetRecipeResponse"
  #       "400":
  #         description: Bad request — invalid recipe ID
  #         content:
  #           application/json:
  #             schema:
  #               $ref: "#/components/schemas/Error"
  #       "404":
  #         description: Recipe not found or not owned by user
  #         content:
  #           application/json:
  #             schema:
  #               $ref: "#/components/schemas/Error"
  #       "500":
  #         description: Internal server error
  #         content:
  #           application/json:
  #             schema:
  #               $ref: "#/components/schemas/Error"
  #
  # /api/setup/admin:
  #   post:
  #     summary: Setup the first admin.
  #     tags:
  #       - Admin
  #     description: This endpoint should only be hit once on system startup.
  #     requestBody:
  #       description: Create Admin Request
  #       required: true
  #       content:
  #         application/json:
  #           schema:
  #             $ref: "#/components/schemas/CreateAdminRequest"
  #     responses:
  #       "200":
  #         description: OK
  #         content:
  #           application/json:
  #             schema:
  #               $ref: "#/components/schemas/CreateAdminResponse"
  #       "409":
  #         description: Status Conflict
  #         content:
  #           application/json:
  #             schema:
  #               $ref: "#/components/schemas/Error"
  #       "422":
  #         description: Unprocessible Entity
  #         content:
  #           application/json:
  #             schema:
  #               $ref: "#/components/schemas/Error"

components:
  schemas:
    Error:
      type: object
      description: Standard error response
      properties:
        code:
          type: string
        error_id:
          type: string
        message:
          type: string
        status:
          type: integer
      required: [code, error_id, message, status]

    Recipe:
      type: object
      properties:
        cook_time_amount:
          type: integer
          format: int32
          minimum: 0
        cook_time_unit:
          $ref: "#/components/schemas/TimeUnit"
        created_at:
          type: string
          format: date-time
        description:
          type: string
        id:
          type: integer
          format: int64
          minimum: 0
        image_url:
          type: string
        prep_time_amount:
          type: integer
          format: int32
          minimum: 0
        prep_time_unit:
          $ref: "#/components/schemas/TimeUnit"
        published:
          type: boolean
        servings:
          type: number
          minimum: 0
          exclusiveMinimum: true
        title:
          type: string
        updated_at:
          type: string
          format: date-time
        user_id:
          type: integer
          format: int64
          minimum: 0
      required:
        - id
        - user_id
        - published
        - title
        - created_at
        - updated_at

    RecipeOwner:
      type: object
      properties:
        first_name:
          type: string
        last_name:
          type: string
        id:
          type: integer
          format: int64
          minimum: 0
      required:
        - first_name
        - last_name
        - id

    RecipeIngredient:
      type: object
      properties:
        id:
          type: integer
          format: int64
          minimum: 0
        image_url:
          type: string
        name:
          type: string
        quantity:
          type: number
        recipe_id:
          type: integer
          format: int64
          minimum: 0
        unit:
          type: string
      required:
        - id
        - recipe_id

    RecipeStep:
      type: object
      properties:
        id:
          type: integer
          format: int64
          minimum: 0
        image_url:
          type: string
        instruction:
          type: string
        recipe_id:
          type: integer
          format: int64
          minimum: 0
        step_number:
          type: integer
          format: int32
          minimum: 0
      required:
        - id
        - recipe_id
        - step_number

    RecipeAndOwner:
      type: object
      properties:
        owner:
          $ref: "#/components/schemas/RecipeOwner"
        recipe:
          $ref: "#/components/schemas/Recipe"

    RecipeWithIngredientsAndSteps:
      allOf:
        - $ref: "#/components/schemas/Recipe"
        - type: object
          properties:
            ingredients:
              type: array
              items:
                $ref: "#/components/schemas/RecipeIngredient"
            steps:
              type: array
              items:
                $ref: "#/components/schemas/RecipeStep"
          required:
            - ingredients
            - steps

    CreateAdminRequest:
      type: object
      required:
        - email
        - first_name
        - last_name
        - password
      properties:
        email:
          type: string
          format: email
        first_name:
          type: string
        last_name:
          type: string
        password:
          type: string

    CreateAdminResponse:
      type: object
      properties:
        user_id:
          type: integer

    CreateRecipeResponse:
      type: object
      properties:
        recipe_id:
          type: integer
          format: int64
          minimum: 0
          description: Recipe ID
      required:
        - recipe_id

    GetPersonalRecipesResponse:
      type: object
      properties:
        recipes:
          type: array
          items:
            $ref: "#/components/schemas/RecipeAndOwner"

    GetRecipeResponse:
      type: object
      properties:
        owner:
          $ref: "#/components/schemas/RecipeOwner"
        recipe:
          $ref: "#/components/schemas/RecipeWithIngredientsAndSteps"
      required:
        - owner
        - recipe

    CreateUserRequest:
      type: object
      required:
        - email
        - first_name
        - last_name
        - password
      properties:
        email:
          type: string
          format: email
        first_name:
          type: string
        last_name:
          type: string
        password:
          type: string

    CreateUserResponse:
      type: object
      properties:
        user_id:
          type: integer

    UserLoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
        password:
          type: string

    UpdateRecipeIngredient:
      type: object
      properties:
        id:
          type: integer
          format: int64
          minimum: 0
        name:
          type: string
        quantity:
          type: number
          minimum: 0
          exclusiveMinimum: true
        unit:
          type: string

    UpdateRecipeStep:
      type: object
      properties:
        id:
          type: integer
          format: int64
          minimum: 0
        instruction:
          type: string
        step_number:
          type: integer
          format: int32
          minimum: 1
      required: []

    UpdateRecipe:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        published:
          type: boolean
        servings:
          type: number
          minimum: 0
          exclusiveMinimum: true
        cook_time_amount:
          type: integer
          format: int32
          minimum: 0
        cook_time_unit:
          $ref: "#/components/schemas/TimeUnit"
        prep_time_amount:
          type: integer
          format: int32
          minimum: 0
        prep_time_unit:
          $ref: "#/components/schemas/TimeUnit"
        ingredients:
          type: array
          items:
            $ref: "#/components/schemas/UpdateRecipeIngredient"
        steps:
          type: array
          items:
            $ref: "#/components/schemas/UpdateRecipeStep"

    TimeUnit:
      type: string
      enum:
        - minutes
        - hours
        - days

    LoginResponse:
      type: object
      properties:
        access_token:
          type: string
          description: >
            JWT access token to use in the Authorization: Bearer header.
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          format: int64
          description: Access token lifetime in seconds.
      required:
        - access_token

    RefreshToken:
      type: object
      properties:
        refresh_token:
          type: string
          description: Refresh token

    CreateIngredientResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          minimum: 0
        quantity:
          type: number
          minimum: 0
          exclusiveMinimum: true
        name:
          type: string
        image_url:
          type: string
        unit:
          type: string
      required:
        - id

    CreateStepResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          minimum: 0
        step_number:
          type: integer
          format: int32
          minimum: 1
        instruction:
          type: string
      required:
        - id
        - step_number

    UpdateIngredientBody:
      type: object
      properties:
        quantity:
          type: number
          minimum: 0
          exclusiveMinimum: true
        name:
          type: string
        unit:
          type: string

    UpdateIngredientImageForm:
      type: object
      properties:
        image:
          type: string
          format: binary
      required:
        - image

    UpdateIngredientResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          minimum: 0
        quantity:
          type: number
          minimum: 0
          exclusiveMinimum: true
        name:
          type: string
        image_url:
          type: string
        unit:
          type: string
      required:
        - id
        - name

    UpdateIngredientImageResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          minimum: 0
        image_url:
          type: string
      required:
        - id
        - image_url

    UpdateStepRequest:
      type: object
      properties:
        step_number:
          type: integer
          format: int32
          minimum: 1
        instruction:
          type: string
        image:
          type: string
          format: binary

    UpdateStepResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          minimum: 0
        instruction:
          type: string
        step_number:
          type: integer
          format: int32
          minimum: 1
        image_url:
          type: string
      required:
        - id
        - step_number

  securitySchemes:
    AccessTokenUserBearer:
      type: http
      scheme: bearer
      bearerFormat: JWT
    AccessTokenAdminBearer:
      type: http
      scheme: bearer
      bearerFormat: JWT

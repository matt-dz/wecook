server {
    listen 80;
    server_name _;

    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log;

    # -------- Static files --------
    location /files/ {
			alias /data/files/;
			autoindex off;
			add_header Access-Control-Allow-Origin *;

			if (-d $request_filename) { return 404; }
			try_files $uri =404;

			etag on;
			expires 1h;
			add_header Cache-Control "public, max-age=3600" always;
    }

		# -------- Backend API --------
		location /api/ {
			proxy_pass http://wecook-backend:8080;
			proxy_http_version 1.1;

			proxy_set_header Host              $http_host;
			proxy_set_header X-Forwarded-Host  $http_host;
			proxy_set_header X-Forwarded-Port  $server_port;

			proxy_set_header X-Real-IP         $remote_addr;
			proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;

			proxy_set_header Upgrade           $http_upgrade;
			proxy_set_header Connection        $connection_upgrade;
		}

		# -------- Frontend --------
		location / {
			proxy_pass http://wecook-frontend:3000;
			proxy_http_version 1.1;

			proxy_set_header Host              $http_host;
			proxy_set_header X-Forwarded-Host  $http_host;
			proxy_set_header X-Forwarded-Port  $server_port;

			proxy_set_header X-Real-IP         $remote_addr;
			proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		
			proxy_set_header Upgrade           $http_upgrade;
			proxy_set_header Connection        $connection_upgrade;
		}
}

# Required for $connection_upgrade above
map $http_upgrade $connection_upgrade {
	default upgrade;
	''      close;
}
